<html>
  <head>
    <script src='jquery-1.7.1.min.js'></script>
    <script src='transformjs.1.0.beta.2.js'></script>
    <style type='text/css'>
      #playfield table {
	margin-left:15%;
	margin-right:15%;
	width:70%;
	height:70%;
	margin-top:5%;  
      }
      #playfield .cell {
	border:1px solid #baab00;
	cursor:pointer;
	font-size:200%;
	text-align:center;
	background-color:#FF7;
	background-image:url(pics/bg.png);
	width:80px;
	height:80px;
      }
      #playfield.blocked .cell {
	cursor:default;
      }
      #playfield .cell.opened, #playfield .cell.stick {
	background-color:#EEE;
	background-image:none;
      }
      #playfield .cell.stick {
	display:none;
      }
    </style>
  </head>
  <body>
    <h1>MEMORY</h1>
    <div id='playfield'>
    </div>
    <div id='won' style='display:none;'>Won !</div>
    <script>

      Array.prototype.shuffle=function() {
	this.sort(Math.random);
      };
      Array.prototype.remove = function(from, to) {
	var array=this;
	var rest = array.slice((to || from) + 1 || array.length);
	array.length = from < 0 ? array.length + from : from;
	return array.push.apply(array, rest);
      };
      Array.prototype.erase=function(e) {
	this.remove(this.indexOf(e));
      };
      Array.prototype.shallowCopy=function() {
	return this.slice(0);
      };
      var Signal=function() {
	var listeners=[];
	this.call=function() {
	  var args=arguments;
	  $.each(listeners,function(k,listener) {
	    listener.fct.apply(listener.obj,args);
	  });
	};
	this.add=function(receiver,fct) {
	  listeners.push({fct:fct,obj:receiver});
	}
      };

      var PlayfieldModel=function(w,h) {
	var field=null;
	var cards=[];
	var _opened=[];

	console.log("....",_opened);
	function init() {
	  var i;
	  for(i=0;i<w*h/2;i++) {
	    cards.push({id:i,text:i});
	  }
	  field=[];
	  $.each(cards,function(k,v) {field.push(v);});
	  $.each(cards,function(k,v) {field.push(v);});
	  field.shuffle();
	  for(i=0;i<w*h;i++) {
	    field[i].status="closed";
	  }
	}
	init();

	var o= {
	  width:w,
	  height:h,
	  cellChanged:new Signal(),
	  field:function(x,y,val) {
	    if(typeof y ==="undefined") {
	      y=x.y;x=x.x;
	    }
	    var p=y*this.width+x;
	    if(val) {
	      field[p]=val;
	      this.cellChanged.call({x:x,y:y});
	    }
	    return field[p];
	  },
	  opened:function() { console.log("_op",_opened);return _opened.shallowCopy();},
	  closed:function() { return $.grep(field,function(v,i){return v.status=="closed";});},
	  open:function(cell) {
	    console.log("nw opening");
	    _opened.push(cell);
	    this.toState([cell],"opened");
	  },

	  closeAll:function() {
	    this.toState(_opened,"closed");
	    _opened=[];
	  },
	  stickOpened:function() {
	    this.toState(_opened,"stick");
	    _opened=[];
	  },

	  toState:function(cells,state) {
	    var self=this;
	    $.each(cells,function(k,cell) {
	      self.field(cell.x,cell.y).status=state;
	      self.cellChanged.call(cell);
	    });
	  }
	};
	return o;
      }(4,5);


      var PlayfieldCellView=function(imgsrc) {
	var image={
	  html:function() {
	  },
	  open:function() {
	  },
	  close:function() {
	  },
	  hide:function() {
	  }
	};
	return image;
      };

      var PlayfieldView=function(el,model) {
	var clickDisabled=false;
	var o={
	  block:function(ms,callback) {
	    clickDisabled=true;
	    $(el).addClass("blocked");
	    var unblocker=function() {
	      $(el).removeClass("blocked");
	      clickDisabled=false;
	    };
	    setTimeout(function() {
	      callback(unblocker);
	    },ms);
	  },
	  cellId:function(x,y) {
	    return "cell_"+x+"_"+y;
	  },
	  cellFromId:function(id) {
	    var p=id.substr(5).split("_");
	    return {x:parseInt(p[0]),y:parseInt(p[1])};
	  },
	  cellContent:function(x,y) {
	    if(model.field(x,y).status=="closed")
	    return "";
	    else
	    return "<img width='70' height'70' src='pics/img"+model.field(x,y).text+".png'/>";
	    return model.field(x,y).text;
	  },
	  init:function()  {
	    var x,y,html="";
	    html+="<table>";
	      for(y=0;y<model.height;y++) {
		html+="<tr>";
		  for(x=0;x<model.width;x++) {
		    html+="<td><div class='cell' id='"+this.cellId(x,y)+"'>";
			html+=this.cellContent(x,y);
			html+="</div></td>";
		  }
		  html+="</tr>";
	      }
	      html+="</table>";
	    $(el).html(html);
	    var self=this;
	    $(".cell",el).click(function(e) {
	      if(clickDisabled)
	      return;
	      if($(e.currentTarget).hasClass("opened") || $(e.currentTarget).hasClass("stick"))
	      return
	      if(self.cellClicked) {
		var c=self.cellFromId($(e.currentTarget).attr("id"));
		self.cellClicked.call(c);
	      }
	    });
	    model.cellChanged.add(this,this.update);
	  },
	  cellClicked:new Signal(),
	  statusOf:function(cell) {
	    var e=$("#"+this.cellId(cell.x,cell.y));
	    if(e.hasClass("opened"))
	    return "opened";
	    if(e.hasClass("stick"))
	    return "stick";
	    return "closed";
	  },

	  update:function(cell) {
	    var id="#"+this.cellId(cell.x,cell.y);

	    var f=model.field(cell);
	    var s=this.statusOf(cell);
	    var cdiv=$(id);
	    var self=this;
	    if(s!=f.status)
	    {
	      cdiv.animate({
		rotateX: '+='+(0.5*Math.PI), //scale: '+=1.5'
		},300,function(){console.log("ready");
		var cnt=self.cellContent(cell.x,cell.y);
		console.log("CNT",cnt);
		cdiv.html(cnt); //self.cellContent(cell.x,cell.y));
		cdiv.removeClass(s);
		cdiv.addClass(f.status);
		cdiv.animate({rotateX: '-='+(0.5*Math.PI)},300);
	      });    
	    }
	  }
	};


	return o;

      }("#playfield",PlayfieldModel);


      var PlayFieldController=function(model,view)  {
	var o={
	  cellClicked:function(cell) {
	    console.log("be",model.opened(),cell);
	    var i=$.inArray(cell,model.opened());
	    console.log("I",i);
	    if(i>=0) {
	      console.log("FOUND",cell);
	      return;
	    }

	    model.open(cell);
	    var opened=model.opened();
	    console.log("OP",opened);
	    if(opened.length>2)
	    model.close(opened);
	    else if(opened.length==2) {
	      view.block(1000,function(unblocker) {
		var cells=$.map(opened,function(v,i) {return model.field(v);});
		if(cells[0].id==cells[1].id) {
		  model.stickOpened();
		  if(model.closed().length==0) {
		    $("#won").show();
		  }
		  } else {
		  model.closeAll();
		}
		setTimeout(unblocker,500);
	      });
	    }

	  },
	  init:function() {
	    var self=this;
	    view.init();
	    view.cellClicked.add(this,function(cell) {
	      self.cellClicked(cell);
	    });
	  }
	};
	return o;
      }(PlayfieldModel,PlayfieldView);

      PlayFieldController.init();

    </script>


  </body>
</html>
